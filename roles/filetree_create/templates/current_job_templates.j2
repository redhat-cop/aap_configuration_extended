{% if (current_job_template_index | default(0)) == 0 %}
---
controller_templates:
{% endif %}
  - name: "{{ current_job_templates_asset_value.name }}"
    description: "{{ template_overrides_resources.job_template[current_job_templates_asset_value.name].description
                     | default(template_overrides_global.job_template.description)
                     | default(current_job_templates_asset_value.description)
    }}"
    organization: "{{ current_job_templates_asset_value.summary_fields.organization.name | default(organization if organization != 'ORGANIZATIONLESS' else 'ToDo: The job template \'' + current_job_templates_asset_value.name + '\' must belong to an organization') }}"
    project: "{{ current_job_templates_asset_value.summary_fields.project.name | default('ToDo: The job template \'' + current_job_templates_asset_value.name + '\' must have a project assigned') }}"
{% if template_overrides_resources.job_template[current_job_templates_asset_value.name].inventory is defined
      or template_overrides_global.job_template.inventory is defined
      or current_job_templates_asset_value.inventory %}
    inventory: "{{ template_overrides_resources.job_template[current_job_templates_asset_value.name].inventory
                   | default(template_overrides_global.job_template.inventory)
                   | default(current_job_templates_asset_value.summary_fields.inventory.name) }}"
{% endif %}
    playbook: "{{ template_overrides_resources.job_template[current_job_templates_asset_value.name].playbook
                  | default(template_overrides_global.job_template.playbook)
                  | default(current_job_templates_asset_value.playbook) }}"
    scm_branch: "{{ template_overrides_resources.job_template[current_job_templates_asset_value.name].scm_branch
                  | default(template_overrides_global.job_template.scm_branch)
                  | default(current_job_templates_asset_value.scm_branch) }}"
    forks: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].forks
                  | default(template_overrides_global.job_template.forks)
                  | default(current_job_templates_asset_value.forks) }}
    limit: "{{ template_overrides_resources.job_template[current_job_templates_asset_value.name].limit
                  | default(template_overrides_global.job_template.limit)
                  | default(current_job_templates_asset_value.limit) }}"
    verbosity: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].verbosity
                  | default(template_overrides_global.job_template.verbosity)
                  | default(current_job_templates_asset_value.verbosity) }}
    job_type: "{{ template_overrides_resources.job_template[current_job_templates_asset_value.name].job_type
                  | default(template_overrides_global.job_template.job_type)
                  | default(current_job_templates_asset_value.job_type) }}"
    job_slice_count: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].job_slice_count
                  | default(template_overrides_global.job_template.job_slice_count)
                  | default(current_job_templates_asset_value.job_slice_count) }}
    use_fact_cache: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].use_fact_cache
                  | default(template_overrides_global.job_template.use_fact_cache)
                  | default(current_job_templates_asset_value.use_fact_cache | bool | lower) }}
{% if current_job_templates_asset_value.summary_fields.credentials %}
    credentials:
{% for credential in current_job_templates_asset_value.summary_fields.credentials %}
      - "{{ credential.name }}"
{% endfor %}
{% endif %}
    allow_simultaneous: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].allow_simultaneous
                           | default(template_overrides_global.job_template.allow_simultaneous)
                           | default(current_job_templates_asset_value.allow_simultaneous | bool | lower) }}
    ask_scm_branch_on_launch: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].ask_scm_branch_on_launch
                                 | default(template_overrides_global.job_template.ask_scm_branch_on_launch)
                                 | default(current_job_templates_asset_value.ask_scm_branch_on_launch | bool | lower) }}
    ask_diff_mode_on_launch: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].ask_diff_mode_on_launch
                                | default(template_overrides_global.job_template.ask_diff_mode_on_launch)
                                | default(current_job_templates_asset_value.ask_diff_mode_on_launch | bool | lower) }}
    ask_tags_on_launch: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].ask_tags_on_launch
                           | default(template_overrides_global.job_template.ask_tags_on_launch)
                           | default(current_job_templates_asset_value.ask_tags_on_launch | bool | lower) }}
    ask_skip_tags_on_launch: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].ask_skip_tags_on_launch
                                | default(template_overrides_global.job_template.ask_skip_tags_on_launch)
                                | default(current_job_templates_asset_value.ask_skip_tags_on_launch | bool | lower) }}
    ask_job_type_on_launch: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].ask_job_type_on_launch
                               | default(template_overrides_global.job_template.ask_job_type_on_launch)
                               | default(current_job_templates_asset_value.ask_job_type_on_launch | bool | lower) }}
    ask_verbosity_on_launch: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].ask_verbosity_on_launch
                                | default(template_overrides_global.job_template.ask_verbosity_on_launch)
                                | default(current_job_templates_asset_value.ask_verbosity_on_launch | bool | lower) }}
    ask_variables_on_launch: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].ask_variables_on_launch
                                | default(template_overrides_global.job_template.ask_variables_on_launch)
                                | default(current_job_templates_asset_value.ask_variables_on_launch | bool | lower) }}
    ask_inventory_on_launch: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].ask_inventory_on_launch
                                | default(template_overrides_global.job_template.ask_inventory_on_launch)
                                | default(current_job_templates_asset_value.ask_inventory_on_launch | bool | lower) }}
    ask_limit_on_launch: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].ask_limit_on_launch
                            | default(template_overrides_global.job_template.ask_limit_on_launch)
                            | default(current_job_templates_asset_value.ask_limit_on_launch | bool | lower) }}
    ask_credential_on_launch: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].ask_credential_on_launch
                                 | default(template_overrides_global.job_template.ask_credential_on_launch)
                                 | default(current_job_templates_asset_value.ask_credential_on_launch | bool | lower) }}
{% if template_overrides_resources.job_template[current_job_templates_asset_value.name].ask_execution_environment_on_launch is defined
      or template_overrides_global.job_template.ask_execution_environment_on_launch is defined
      or current_job_templates_asset_value.ask_execution_environment_on_launch is defined %}
    ask_execution_environment_on_launch: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].ask_execution_environment_on_launch
                                            | default(template_overrides_global.job_template.ask_execution_environment_on_launch)
                                            | default(current_job_templates_asset_value.ask_execution_environment_on_launch | bool | lower) }}
{% endif %}
{% if template_overrides_resources.job_template[current_job_templates_asset_value.name].ask_labels_on_launch is defined
      or template_overrides_global.job_template.ask_labels_on_launch is defined
      or current_job_templates_asset_value.ask_labels_on_launch is defined %}
    ask_labels_on_launch: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].ask_labels_on_launch
                             | default(template_overrides_global.job_template.ask_labels_on_launch)
                             | default(current_job_templates_asset_value.ask_labels_on_launch | bool | lower) }}
{% endif %}
{% if template_overrides_resources.job_template[current_job_templates_asset_value.name].ask_forks_on_launch is defined
      or template_overrides_global.job_template.ask_forks_on_launch is defined
      or current_job_templates_asset_value.ask_forks_on_launch is defined %}
    ask_forks_on_launch: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].ask_forks_on_launch
                            | default(template_overrides_global.job_template.ask_forks_on_launch)
                            | default(current_job_templates_asset_value.ask_forks_on_launch | bool | lower) }}
{% endif %}
{% if template_overrides_resources.job_template[current_job_templates_asset_value.name].ask_job_slice_count_on_launch is defined
      or template_overrides_global.job_template.ask_job_slice_count_on_launch is defined
      or current_job_templates_asset_value.ask_job_slice_count_on_launch is defined %}
    ask_job_slice_count_on_launch: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].ask_job_slice_count_on_launch
                                      | default(template_overrides_global.job_template.ask_job_slice_count_on_launch)
                                      | default(current_job_templates_asset_value.ask_job_slice_count_on_launch | bool | lower) }}
{% endif %}
{% if template_overrides_resources.job_template[current_job_templates_asset_value.name].ask_timeout_on_launch is defined
      or template_overrides_global.job_template.ask_timeout_on_launch is defined
      or current_job_templates_asset_value.ask_timeout_on_launch is defined %}
    ask_timeout_on_launch: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].ask_timeout_on_launch
                              | default(template_overrides_global.job_template.ask_timeout_on_launch)
                              | default(current_job_templates_asset_value.ask_timeout_on_launch | bool | lower) }}
{% endif %}
{% if template_overrides_resources.job_template[current_job_templates_asset_value.name].ask_instance_groups_on_launch is defined
      or template_overrides_global.job_template.ask_instance_groups_on_launch is defined
      or current_job_templates_asset_value.ask_instance_groups_on_launch is defined %}
    ask_instance_groups_on_launch: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].ask_instance_groups_on_launch
                                      | default(template_overrides_global.job_template.ask_instance_groups_on_launch)
                                      | default(current_job_templates_asset_value.ask_instance_groups_on_launch | bool | lower) }}
{% endif %}
{% if template_overrides_resources.job_template[current_job_templates_asset_value.name].extra_vars is defined
      or template_overrides_global.job_template.extra_vars is defined
      or current_job_templates_asset_value.extra_vars and current_job_templates_asset_value.extra_vars | length > 3 %}
    extra_vars:
      {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].extra_vars
         | default(template_overrides_global.job_template.extra_vars)
         | default(current_job_templates_asset_value.extra_vars)
         | from_yaml | to_nice_yaml(indent=2)
         | indent(width=6, first=False)
         | regex_replace('(^[^:]*): (.*){{', '\1: !unsafe \2{{', multiline=True)
      }}
{%- endif %}
    job_tags: "{{ template_overrides_resources.job_template[current_job_templates_asset_value.name].job_tags
                  | default(template_overrides_global.job_template.job_tags)
                  | default(current_job_templates_asset_value.job_tags) }}"
    force_handlers: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].force_handlers
                       | default(template_overrides_global.job_template.force_handlers)
                       | default(current_job_templates_asset_value.force_handlers | bool | lower) }}
    skip_tags: "{{ template_overrides_resources.job_template[current_job_templates_asset_value.name].skip_tags
                   | default(template_overrides_global.job_template.skip_tags)
                   | default(current_job_templates_asset_value.skip_tags) }}"
    start_at_task: "{{ template_overrides_resources.job_template[current_job_templates_asset_value.name].start_at_task
                       | default(template_overrides_global.job_template.start_at_task)
                       | default(current_job_templates_asset_value.start_at_task) }}"
    timeout: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].timeout
                | default(template_overrides_global.job_template.timeout)
                | default(current_job_templates_asset_value.timeout | int) }}
{% if is_aap and (template_overrides_resources.job_template[current_job_templates_asset_value.name].execution_environment is defined
                  or template_overrides_global.job_template.execution_environment is defined
                  or current_job_templates_asset_value.summary_fields.execution_environment is defined) %}
    execution_environment: "{{ template_overrides_resources.job_template[current_job_templates_asset_value.name].execution_environment
                               | default(template_overrides_global.job_template.execution_environment)
                               | default(current_job_templates_asset_value.summary_fields.execution_environment.name) }}"
{% endif %}
{% if not is_aap %}
    custom_virtualenv: "{{ template_overrides_resources.job_template[current_job_templates_asset_value.name].custom_virtualenv
                           | default(template_overrides_global.job_template.custom_virtualenv)
                           | default(current_job_templates_asset_value.custom_virtualenv | default(omit)) }}"
{% endif %}
    host_config_key: "{{ template_overrides_resources.job_template[current_job_templates_asset_value.name].host_config_key
                         | default(template_overrides_global.job_template.host_config_key)
                         | default(current_job_templates_asset_value.host_config_key) }}"
{% if query_labels | length > 0 %}
    labels:
{% for label in query_labels %}
      - "{{ label.name }}"
{% endfor %}
{% endif %}
{% if query_notification_error | length > 0 %}
    notification_templates_error:
{% for notification_error  in query_notification_error %}
      - "{{ notification_error.name }}"
{% endfor %}
{% endif %}
{% if query_notification_started | length > 0 %}
    notification_templates_started:
{% for notification_started  in query_notification_started %}
      - "{{ notification_started.name }}"
{% endfor %}
{% endif %}
{% if query_notification_success | length > 0 %}
    notification_templates_success:
{% for notification_success  in query_notification_success %}
      - "{{ notification_success.name }}"
{% endfor %}
{% endif %}
    survey_enabled: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].survey_enabled
                       | default(template_overrides_global.job_template.survey_enabled)
                       | default(current_job_templates_asset_value.survey_enabled | bool | lower) }}
{% set survey_spec_contents = template_overrides_resources.job_template[current_job_templates_asset_value.name].survey_spec
                              | default(template_overrides_global.job_template.survey_spec)
                              | default(query(controller_api_plugin, current_job_templates_asset_value.related.survey_spec,
                                              host=controller_hostname, oauth_token=controller_oauthtoken, verify_ssl=controller_validate_certs)[0])
                              | from_yaml | to_nice_yaml(indent=2,width=500) | regex_replace("\n\n[ ]*", "\\\\n")
                              | indent(width=6, first=False) | replace("'{{", "!unsafe \'{{") | replace("^$", "") | replace("$encrypted$", "")
-%}
{% if template_overrides_resources.job_template[current_job_templates_asset_value.name].survey_spec is defined
      or template_overrides_global.job_template.survey_spec is defined
      or (current_job_templates_asset_value.related.survey_spec is defined and survey_spec_contents | length > 3) %}
    survey_spec:
      {{ survey_spec_contents }}
{% endif %}
    become_enabled: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].become_enabled
                       | default(template_overrides_global.job_template.become_enabled)
                       | default(current_job_templates_asset_value.become_enabled | bool | lower) }}
    diff_mode: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].diff_mode
                       | default(template_overrides_global.job_template.diff_mode)
                       | default(current_job_templates_asset_value.diff_mode | bool | lower) }}
    webhook_service: "{{ template_overrides_resources.job_template[current_job_templates_asset_value.name].webhook_service
                       | default(template_overrides_global.job_template.webhook_service)
                       | default(current_job_templates_asset_value.webhook_service) }}"
{% if template_overrides_resources.job_template[current_job_templates_asset_value.name].webhook_credential is defined
      or template_overrides_global.job_template.webhook_credential is defined
      or current_job_templates_asset_value.webhook_credential %}
    webhook_credential: "{{ template_overrides_resources.job_template[current_job_templates_asset_value.name].webhook_credential
                            | default(template_overrides_global.job_template.webhook_credential)
                            | default(current_job_templates_asset_value.webhook_credential) }}"
{% endif %}
{% if template_overrides_resources.job_template[current_job_templates_asset_value.name].prevent_instance_group_fallback is defined
      or template_overrides_global.job_template.prevent_instance_group_fallback is defined
      or current_job_templates_asset_value.prevent_instance_group_fallback is defined %}
    prevent_instance_group_fallback: {{ template_overrides_resources.job_template[current_job_templates_asset_value.name].prevent_instance_group_fallback
                                        | default(template_overrides_global.job_template.prevent_instance_group_fallback)
                                        | default(current_job_templates_asset_value.prevent_instance_group_fallback | bool | lower) }}
{% endif %}
{% if last_job_template | default(true) | bool | lower %}
...
{% endif %}
